name: Semantic Docker Build with User-Focused Release Notes

on:
  push:
    branches: [ main, master ]

# Prevent concurrent releases
concurrency:
  group: semantic-release
  cancel-in-progress: false

env:
  IMAGE_NAME: jyothiram266/doc-semver

jobs:
  semantic-version-and-build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: get_tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"

      - name: Check for new commits
        id: check_commits
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          
          if [ "$LATEST_TAG" = "0.0.0" ]; then
            COMMIT_COUNT=$(git rev-list --count HEAD)
          else
            COMMIT_COUNT=$(git rev-list --count ${LATEST_TAG}..HEAD 2>/dev/null || echo "0")
          fi
          
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "‚ùå No new commits since last tag ($LATEST_TAG)"
            echo "has_commits=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Found $COMMIT_COUNT new commit(s) since last tag"
            echo "has_commits=true" >> $GITHUB_OUTPUT
          fi

      - name: Analyze commits for version bump
        id: version_bump
        if: steps.check_commits.outputs.has_commits == 'true'
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          
          if [ "$LATEST_TAG" = "0.0.0" ]; then
            COMMITS=$(git log --pretty=format:"%s" HEAD)
          else
            COMMITS=$(git log --pretty=format:"%s" ${LATEST_TAG}..HEAD)
          fi
          
          echo "Commits to analyze:"
          echo "$COMMITS"
          
          HAS_BREAKING=false
          HAS_FEATURE=false
          HAS_FIX=false
          
          # Check for breaking changes
          if echo "$COMMITS" | grep -qiE "(^major:|BREAKING CHANGE|^[a-zA-Z]+!:)"; then
            HAS_BREAKING=true
          fi
          
          # Check for features
          if echo "$COMMITS" | grep -qiE "^(feat|feature|minor)(\([^)]*\))?:"; then
            HAS_FEATURE=true
          fi
          
          # Check for fixes
          if echo "$COMMITS" | grep -qiE "^(fix|patch|bugfix)(\([^)]*\))?:"; then
            HAS_FIX=true
          fi
          
          # Determine bump type
          if [ "$HAS_BREAKING" = true ]; then
            BUMP_TYPE="major"
            echo "üö® Breaking changes detected - MAJOR version bump"
          elif [ "$HAS_FEATURE" = true ]; then
            BUMP_TYPE="minor"
            echo "‚ú® New features detected - MINOR version bump"
          elif [ "$HAS_FIX" = true ]; then
            BUMP_TYPE="patch"
            echo "üêõ Bug fixes detected - PATCH version bump"
          else
            BUMP_TYPE="patch"
            echo "üì¶ No specific change type detected - defaulting to PATCH version bump"
          fi
          
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Calculate new version
        id: new_version
        if: steps.check_commits.outputs.has_commits == 'true'
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          BUMP_TYPE="${{ steps.version_bump.outputs.bump_type }}"
          
          VERSION=${LATEST_TAG#v}
          VERSION=$(echo "$VERSION" | sed 's/-.*$//')
          
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}
          
          MAJOR=$(echo "$MAJOR" | grep -o '[0-9]*' | head -1)
          MINOR=$(echo "$MINOR" | grep -o '[0-9]*' | head -1)
          PATCH=$(echo "$PATCH" | grep -o '[0-9]*' | head -1)
          
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}
          
          case $BUMP_TYPE in
            "major")
              NEW_MAJOR=$((MAJOR + 1))
              NEW_MINOR=0
              NEW_PATCH=0
              ;;
            "minor")
              NEW_MAJOR=$MAJOR
              NEW_MINOR=$((MINOR + 1))
              NEW_PATCH=0
              ;;
            "patch")
              NEW_MAJOR=$MAJOR
              NEW_MINOR=$MINOR
              NEW_PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH"
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Previous version: $LATEST_TAG"
          echo "New version: $NEW_VERSION"

      - name: Check if version already exists
        id: check_version
        if: steps.check_commits.outputs.has_commits == 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          
          if git rev-parse "v$NEW_VERSION" >/dev/null 2>&1; then
            echo "‚ùå ERROR: Tag v$NEW_VERSION already exists!"
            exit 1
          else
            echo "‚úÖ Version v$NEW_VERSION is available"
          fi

      - name: Set up Docker Buildx
        if: steps.check_commits.outputs.has_commits == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: steps.check_commits.outputs.has_commits == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        if: steps.check_commits.outputs.has_commits == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.new_version.outputs.new_version }}
            ${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.version=${{ steps.new_version.outputs.new_version }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract high-level changes
        id: extract_changes
        if: steps.check_commits.outputs.has_commits == 'true'
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          
          # Get all commits
          if [ "$LATEST_TAG" = "0.0.0" ]; then
            COMMITS=$(git log --pretty=format:"%s%x09%b" HEAD)
          else
            COMMITS=$(git log --pretty=format:"%s%x09%b" ${LATEST_TAG}..HEAD)
          fi
          
          # Extract key highlights (breaking changes and major features)
          BREAKING_HIGHLIGHTS=""
          FEATURE_HIGHLIGHTS=""
          
          # Count changes by type
          BREAKING_COUNT=0
          FEATURE_COUNT=0
          FIX_COUNT=0
          DOCS_COUNT=0
          CHORE_COUNT=0
          
          while IFS=$'\t' read -r subject body; do
            if [ -z "$subject" ]; then continue; fi
            
            # Count by type
            if echo "$subject" | grep -qiE "(BREAKING CHANGE|^major:|^[a-zA-Z]+!:)" || echo "$body" | grep -qiE "BREAKING CHANGE"; then
              BREAKING_COUNT=$((BREAKING_COUNT + 1))
              # Extract breaking change description
              if [ "$BREAKING_COUNT" -le 5 ]; then
                CLEAN_SUBJECT=$(echo "$subject" | sed 's/^[a-zA-Z]*!*: *//' | sed 's/^major: *//')
                BREAKING_HIGHLIGHTS="${BREAKING_HIGHLIGHTS}- ${CLEAN_SUBJECT}
          "
              fi
            elif echo "$subject" | grep -qiE "^(feat|feature|minor)(\([^)]*\))?:"; then
              FEATURE_COUNT=$((FEATURE_COUNT + 1))
              # Extract major features only (first 10)
              if [ "$FEATURE_COUNT" -le 10 ]; then
                CLEAN_SUBJECT=$(echo "$subject" | sed 's/^feat[^:]*: *//' | sed 's/^feature[^:]*: *//' | sed 's/^minor[^:]*: *//')
                FEATURE_HIGHLIGHTS="${FEATURE_HIGHLIGHTS}- ${CLEAN_SUBJECT}
          "
              fi
            elif echo "$subject" | grep -qiE "^(fix|patch|bugfix)(\([^)]*\))?:"; then
              FIX_COUNT=$((FIX_COUNT + 1))
            elif echo "$subject" | grep -qiE "^docs?(\([^)]*\))?:"; then
              DOCS_COUNT=$((DOCS_COUNT + 1))
            else
              CHORE_COUNT=$((CHORE_COUNT + 1))
            fi
          done <<< "$COMMITS"
          
          # Save to outputs
          {
            echo "breaking_highlights<<EOF"
            echo "$BREAKING_HIGHLIGHTS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          {
            echo "feature_highlights<<EOF"
            echo "$FEATURE_HIGHLIGHTS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "breaking_count=$BREAKING_COUNT" >> $GITHUB_OUTPUT
          echo "feature_count=$FEATURE_COUNT" >> $GITHUB_OUTPUT
          echo "fix_count=$FIX_COUNT" >> $GITHUB_OUTPUT
          echo "docs_count=$DOCS_COUNT" >> $GITHUB_OUTPUT
          echo "chore_count=$CHORE_COUNT" >> $GITHUB_OUTPUT

      - name: Get statistics
        id: stats
        if: steps.check_commits.outputs.has_commits == 'true'
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          
          # Get unique contributors
          if [ "$LATEST_TAG" = "0.0.0" ]; then
            CONTRIBUTORS=$(git log --pretty=format:"%an" HEAD | sort -u | wc -l)
            CONTRIBUTORS_LIST=$(git log --pretty=format:"%an" HEAD | sort -u | head -10 | paste -sd ", " -)
          else
            CONTRIBUTORS=$(git log --pretty=format:"%an" ${LATEST_TAG}..HEAD | sort -u | wc -l)
            CONTRIBUTORS_LIST=$(git log --pretty=format:"%an" ${LATEST_TAG}..HEAD | sort -u | head -10 | paste -sd ", " -)
          fi
          
          # Get files changed
          if [ "$LATEST_TAG" = "0.0.0" ]; then
            FILES_CHANGED=$(git diff --name-only $(git hash-object -t tree /dev/null) HEAD 2>/dev/null | wc -l || echo "0")
            LINES_STATS=$(git diff --shortstat $(git hash-object -t tree /dev/null) HEAD 2>/dev/null || echo "")
          else
            FILES_CHANGED=$(git diff --name-only ${LATEST_TAG}..HEAD 2>/dev/null | wc -l || echo "0")
            LINES_STATS=$(git diff --shortstat ${LATEST_TAG}..HEAD 2>/dev/null || echo "")
          fi
          
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT
          echo "contributors_list=$CONTRIBUTORS_LIST" >> $GITHUB_OUTPUT
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "lines_stats=$LINES_STATS" >> $GITHUB_OUTPUT

      - name: Generate user-focused release notes
        id: release_notes
        if: steps.check_commits.outputs.has_commits == 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          BUMP_TYPE="${{ steps.version_bump.outputs.bump_type }}"
          TOTAL_COMMITS=${{ steps.check_commits.outputs.commit_count }}
          
          # Get extracted data
          BREAKING_COUNT=${{ steps.extract_changes.outputs.breaking_count }}
          FEATURE_COUNT=${{ steps.extract_changes.outputs.feature_count }}
          FIX_COUNT=${{ steps.extract_changes.outputs.fix_count }}
          DOCS_COUNT=${{ steps.extract_changes.outputs.docs_count }}
          CHORE_COUNT=${{ steps.extract_changes.outputs.chore_count }}
          
          CONTRIBUTORS=${{ steps.stats.outputs.contributors }}
          CONTRIBUTORS_LIST="${{ steps.stats.outputs.contributors_list }}"
          FILES_CHANGED=${{ steps.stats.outputs.files_changed }}
          LINES_STATS="${{ steps.stats.outputs.lines_stats }}"
          
          # Determine release type messaging
          case $BUMP_TYPE in
            "major")
              RELEASE_EMOJI="üö®"
              RELEASE_TYPE="MAJOR RELEASE"
              RELEASE_DESC="This is a major release with breaking changes. Please review the migration guide below."
              ;;
            "minor")
              RELEASE_EMOJI="‚ú®"
              RELEASE_TYPE="FEATURE RELEASE"
              RELEASE_DESC="This release introduces new features and improvements while maintaining backward compatibility."
              ;;
            "patch")
              RELEASE_EMOJI="üêõ"
              RELEASE_TYPE="MAINTENANCE RELEASE"
              RELEASE_DESC="This release includes bug fixes, performance improvements, and minor updates."
              ;;
          esac
          
          RELEASE_DATE=$(date -u '+%B %d, %Y')
          
          # Start building release notes
          cat > release_notes.md << EOF
          # ${RELEASE_EMOJI} ${RELEASE_TYPE}
          
          **Version ${NEW_VERSION}** | Released on ${RELEASE_DATE}
          
          ${RELEASE_DESC}
          
          EOF
          
          # Add breaking changes section if any
          if [ "$BREAKING_COUNT" -gt 0 ]; then
            cat >> release_notes.md << 'BREAKING_EOF'
          ## ‚ö†Ô∏è Breaking Changes
          
          This release contains **${BREAKING_COUNT}** breaking change(s). Please review carefully before upgrading.
          
          BREAKING_EOF
            
            # Substitute the count
            sed -i "s/\${BREAKING_COUNT}/$BREAKING_COUNT/g" release_notes.md
            
            # Add highlights if any
            if [ ! -z "${{ steps.extract_changes.outputs.breaking_highlights }}" ]; then
              cat >> release_notes.md << 'EOF'
          ### What changed:
          ${{ steps.extract_changes.outputs.breaking_highlights }}
          
          ### Migration Guide
          
          Please refer to the [full changelog](https://github.com/${{ github.repository }}/compare/${LATEST_TAG}...v${NEW_VERSION}) for detailed migration instructions.
          
          EOF
            fi
          fi
          
          # Add features section
          if [ "$FEATURE_COUNT" -gt 0 ]; then
            cat >> release_notes.md << 'FEATURES_EOF'
          ## ‚ú® What's New
          
          This release includes **${FEATURE_COUNT}** new feature(s) and enhancement(s).
          
          FEATURES_EOF
            
            sed -i "s/\${FEATURE_COUNT}/$FEATURE_COUNT/g" release_notes.md
            
            # Add feature highlights
            if [ ! -z "${{ steps.extract_changes.outputs.feature_highlights }}" ]; then
              cat >> release_notes.md << 'EOF'
          ### Highlights:
          ${{ steps.extract_changes.outputs.feature_highlights }}
          EOF
              
              if [ "$FEATURE_COUNT" -gt 10 ]; then
                cat >> release_notes.md << EOF
          
          _...and $(($FEATURE_COUNT - 10)) more features. See the [full changelog](https://github.com/${{ github.repository }}/compare/${LATEST_TAG}...v${NEW_VERSION}) for complete details._
          
          EOF
              else
                echo "" >> release_notes.md
              fi
            fi
          fi
          
          # Add improvements section
          if [ "$FIX_COUNT" -gt 0 ] || [ "$DOCS_COUNT" -gt 0 ] || [ "$CHORE_COUNT" -gt 0 ]; then
            cat >> release_notes.md << EOF
          ## üîß Improvements & Fixes
          
          EOF
            
            if [ "$FIX_COUNT" -gt 0 ]; then
              echo "- **${FIX_COUNT}** bug fixes and stability improvements" >> release_notes.md
            fi
            
            if [ "$DOCS_COUNT" -gt 0 ]; then
              echo "- **${DOCS_COUNT}** documentation updates" >> release_notes.md
            fi
            
            if [ "$CHORE_COUNT" -gt 0 ]; then
              echo "- **${CHORE_COUNT}** maintenance and dependency updates" >> release_notes.md
            fi
            
            echo "" >> release_notes.md
          fi
          
          # Docker installation section
          cat >> release_notes.md << EOF
          ## üê≥ Installation
          
          ### Docker
          
          \`\`\`bash
          # Pull the latest version
          docker pull ${{ env.IMAGE_NAME }}:${NEW_VERSION}
          
          # Or use the latest tag
          docker pull ${{ env.IMAGE_NAME }}:latest
          \`\`\`
          
          ### Upgrade from previous version
          
          \`\`\`bash
          # Stop existing container
          docker stop your-container-name
          
          # Pull new version
          docker pull ${{ env.IMAGE_NAME }}:${NEW_VERSION}
          
          # Start with new version
          docker run -d ${{ env.IMAGE_NAME }}:${NEW_VERSION}
          \`\`\`
          
          EOF
          
          # Statistics section
          cat >> release_notes.md << EOF
          ## üìä Release Statistics
          
          | Metric | Value |
          |--------|-------|
          | **Version** | v${NEW_VERSION} |
          | **Previous Version** | ${LATEST_TAG} |
          | **Total Changes** | ${TOTAL_COMMITS} commits |
          | **Contributors** | ${CONTRIBUTORS} |
          | **Files Changed** | ${FILES_CHANGED} |
          EOF
          
          if [ ! -z "$LINES_STATS" ]; then
            echo "| **Lines Changed** | ${LINES_STATS} |" >> release_notes.md
          fi
          
          cat >> release_notes.md << EOF
          | **Release Date** | ${RELEASE_DATE} |
          
          EOF
          
          # Contributors section (if >1)
          if [ "$CONTRIBUTORS" -gt 1 ]; then
            cat >> release_notes.md << EOF
          ## üë• Contributors
          
          Thank you to everyone who contributed to this release:
          
          ${CONTRIBUTORS_LIST}
          
          EOF
          fi
          
          # Links section
          cat >> release_notes.md << EOF
          ## üîó Resources
          
          - üì¶ **Docker Hub**: [${IMAGE_NAME}](https://hub.docker.com/r/${{ env.IMAGE_NAME }})
          - üìù **Full Changelog**: [${LATEST_TAG}...v${NEW_VERSION}](https://github.com/${{ github.repository }}/compare/${LATEST_TAG}...v${NEW_VERSION})
          - üíª **Source Code**: [v${NEW_VERSION}](https://github.com/${{ github.repository }}/tree/v${NEW_VERSION})
          - üêõ **Report Issues**: [Open an issue](https://github.com/${{ github.repository }}/issues/new)
          
          ---
          
          **Need help?** Check our [documentation](https://github.com/${{ github.repository }}#readme) or [open an issue](https://github.com/${{ github.repository }}/issues/new).
          EOF
          
          echo "release_notes_file=release_notes.md" >> $GITHUB_OUTPUT
          
          # Preview
          echo "=== GENERATED RELEASE NOTES ==="
          cat release_notes.md
          echo "==============================="

      - name: Create GitHub Release
        if: steps.check_commits.outputs.has_commits == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.new_version.outputs.new_version }}
          name: "Release v${{ steps.new_version.outputs.new_version }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release notes as artifact
        if: steps.check_commits.outputs.has_commits == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-v${{ steps.new_version.outputs.new_version }}
          path: release_notes.md
          retention-days: 90

      - name: Summary
        if: steps.check_commits.outputs.has_commits == 'true'
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # üöÄ Release v${{ steps.new_version.outputs.new_version }} Published
          
          ## Summary
          - **Type**: ${{ steps.version_bump.outputs.bump_type }}
          - **Changes**: ${{ steps.check_commits.outputs.commit_count }} commits
          - **Breaking Changes**: ${{ steps.extract_changes.outputs.breaking_count }}
          - **New Features**: ${{ steps.extract_changes.outputs.feature_count }}
          - **Bug Fixes**: ${{ steps.extract_changes.outputs.fix_count }}
          
          ## Docker
          - \`${{ env.IMAGE_NAME }}:${{ steps.new_version.outputs.new_version }}\`
          - \`${{ env.IMAGE_NAME }}:latest\`
          
          [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.new_version.outputs.new_version }})
          EOF
